<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแจ้งงาน - ป.บันเทิงศิลป์</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        :root {
            --bg-color: #F9FAFB; /* Soft Gray Background */
            --primary-color: #3B82F6; /* Professional Blue */
            --primary-light: #DBEAFE; /* Lighter Blue for highlights */
            --text-color: #1F2937; /* Dark Charcoal for text */
            --border-color: #E5E7EB; /* Subtle borders */
            --white-color: #FFFFFF;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-text-size-adjust: 100%; /* Prevent font scaling on mobile */
        }

        .navbar {
            background-color: var(--white-color);
            border-bottom: 1px solid var(--border-color);
        }
        
        .navbar-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }

        .navbar-brand p {
            font-size: 0.9rem;
            margin: 0;
            color: #6B7280; /* Medium Gray */
        }

        .card {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* More rounded corners */
            box-shadow: 0 4px 12px rgba(0,0,0,.05);
            background-color: var(--white-color);
        }
        
        .card-title i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        .table {
            word-wrap: break-word;
        }

        .table thead {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .table th, .table td {
            vertical-align: middle;
        }
        
        .table .date-col { width: 30%; }
        .table .day-col { width: 25%; }


        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
        }

        .btn {
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 500;
        }

        .btn-primary:hover {
            background-color: #2563EB; /* Darker blue on hover */
            border-color: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 500;
        }
        
        .btn-outline-primary:hover, .btn-check:checked+.btn-outline-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        #admin-view {
            display: none;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
        }

        .progress-bar-custom {
            width: 0%;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.2s ease-in-out;
        }

        /* --- Mobile Responsive Adjustments --- */
        @media (max-width: 576px) {
            .navbar-brand h1 {
                font-size: 1.25rem;
            }
            .navbar-brand p {
                font-size: 0.8rem;
            }
            .card-body {
                padding: 1rem;
            }
            .table {
                font-size: 0.9rem;
            }
            .table th, .table td {
                padding: 0.75rem 0.5rem;
            }
            .table .date-col, .table .day-col {
                width: auto; /* Let columns resize on mobile */
                min-width: 110px; /* Ensure date is not too cramped */
            }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <h1>ระบบแจ้งงาน</h1>
                <p>วงดนตรีอยุธยา ป.บันเทิงศิลป์</p>
            </a>
            <div class="d-flex">
                <button id="login-btn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
                    <i class="fa-solid fa-right-to-bracket"></i><span class="d-none d-sm-inline ms-1">Admin Login</span>
                </button>
                <button id="logout-btn" class="btn btn-danger" style="display:none;">
                    <i class="fa-solid fa-right-from-bracket"></i><span class="d-none d-sm-inline ms-1">Logout</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4 mb-4">
        <!-- User View -->
        <div id="user-view">
            <div class="card">
                <div class="card-body p-md-4">
                    <h5 class="card-title mb-3"><i class="fa-solid fa-calendar-days"></i>ตารางงาน</h5>
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-6 col-sm-4 col-md-3">
                             <label for="year-select-user" class="form-label visually-hidden">ปี</label>
                             <select id="year-select-user" class="form-select"></select>
                        </div>
                        <div class="col-6 col-sm-5 col-md-4">
                             <label for="month-select-user" class="form-label visually-hidden">เดือน</label>
                             <select id="month-select-user" class="form-select"></select>
                        </div>
                        <div class="col-12 col-sm-auto ms-sm-auto mt-2 mt-sm-0">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check day-filter" name="dayFilterUser" id="allDaysUser" value="all" checked>
                                <label class="btn btn-outline-primary btn-sm" for="allDaysUser">ทุกวัน</label>
                                <input type="radio" class="btn-check day-filter" name="dayFilterUser" id="weekendUser" value="weekend">
                                <label class="btn btn-outline-primary btn-sm" for="weekendUser">ส./อา.</label>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col" class="date-col">วันที่</th>
                                    <th scope="col" class="day-col">วัน</th>
                                    <th scope="col">รายละเอียดงาน</th>
                                </tr>
                            </thead>
                            <tbody id="events-table-body-user">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view">
            <div class="card">
                <div class="card-body p-md-4">
                    <h5 class="card-title mb-3"><i class="fa-solid fa-pencil"></i>จัดการข้อมูลงาน (Admin)</h5>
                     <div class="row g-2 align-items-center mb-3">
                        <div class="col-6 col-sm-4 col-md-3">
                             <label for="year-select-admin" class="form-label visually-hidden">ปี</label>
                             <select id="year-select-admin" class="form-select"></select>
                        </div>
                        <div class="col-6 col-sm-5 col-md-4">
                             <label for="month-select-admin" class="form-label visually-hidden">เดือน</label>
                             <select id="month-select-admin" class="form-select"></select>
                        </div>
                        <div class="col-12 col-sm-auto ms-sm-auto mt-2 mt-sm-0">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check day-filter" name="dayFilterAdmin" id="allDaysAdmin" value="all" checked>
                                <label class="btn btn-outline-primary btn-sm" for="allDaysAdmin">ทุกวัน</label>
                                <input type="radio" class="btn-check day-filter" name="dayFilterAdmin" id="weekendAdmin" value="weekend">
                                <label class="btn btn-outline-primary btn-sm" for="weekendAdmin">ส./อา.</label>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                         <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col" class="date-col">วันที่</th>
                                    <th scope="col" class="day-col">วัน</th>
                                    <th scope="col">รายละเอียดงาน</th>
                                </tr>
                            </thead>
                            <tbody id="events-table-body-admin">
                                <!-- Admin data form will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="save-btn" class="btn btn-primary w-100 mt-3 py-2">
                        <i class="fa-solid fa-floppy-disk"></i>บันทึกข้อมูล
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Admin Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fa-solid fa-right-to-bracket"></i>Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function() {
            // --- CONFIGURATION ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMaQEh2viEg7ufz8gQfsEoovDz0cW9FhC64x_awDHcyAKNzXx0g6hCDtz2FfEF9J1L2Q/exec";
            const START_YEAR = 2025;
            const END_YEAR = 2026;
            const APP_START_MONTH = 7; // August (0-indexed)

            // --- STATE ---
            let currentView = 'user';
            let monthlyEventsData = []; // Cache for fetched data
            let dayFilter = 'all'; // 'all' or 'weekend'

            // --- HELPER FUNCTIONS ---
            function getDayName(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('th-TH', { weekday: 'long' });
            }

            function formatShortDate(dateString) {
                const date = new Date(dateString);
                const shortMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
                
                const day = date.getDate();
                const monthIndex = date.getMonth();
                const month = shortMonths[monthIndex];
                const year = (date.getFullYear() + 543).toString().slice(-2);

                return `${day} ${month} ${year}`;
            }

            // --- UI FUNCTIONS ---
            function initializeDropdowns() {
                const $yearSelectUser = $('#year-select-user');
                const $yearSelectAdmin = $('#year-select-admin');

                for (let year = START_YEAR; year <= END_YEAR; year++) {
                    const beYear = year + 543;
                    $yearSelectUser.append(`<option value="${year}">พ.ศ. ${beYear}</option>`);
                    $yearSelectAdmin.append(`<option value="${year}">พ.ศ. ${beYear}</option>`);
                }

                updateMonthDropdowns();
            }

            function updateMonthDropdowns() {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();

                const selectedYearUser = parseInt($('#year-select-user').val());
                const selectedYearAdmin = parseInt($('#year-select-admin').val());

                populateMonthsForYear('#month-select-user', selectedYearUser, currentYear, currentMonth);
                populateMonthsForYear('#month-select-admin', selectedYearAdmin, currentYear, currentMonth);
            }

            function populateMonthsForYear(selector, selectedYear, currentYear, currentMonth) {
                const $monthSelect = $(selector);
                $monthSelect.empty();
                const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                
                let startMonth = 0;
                if (selectedYear === START_YEAR) {
                    startMonth = APP_START_MONTH;
                }
                if (selectedYear === currentYear) {
                    startMonth = Math.max(startMonth, currentMonth);
                }

                for (let i = startMonth; i < 12; i++) {
                    const monthValue = String(i + 1).padStart(2, '0');
                    $monthSelect.append(`<option value="${monthValue}">${months[i]}</option>`);
                }
            }

            function showLoader(title) {
                Swal.fire({
                    title: title,
                    html: `
                        <p>กำลังดำเนินการ...</p>
                        <div class="progress-container">
                            <div id="swal-progress-bar" class="progress-bar-custom" style="width: 10%"></div>
                        </div>
                    `,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            }

            function renderCurrentTable() {
                const isUserView = currentView === 'user';
                const tbodySelector = isUserView ? '#events-table-body-user' : '#events-table-body-admin';
                
                const $tbody = $(tbodySelector);
                $tbody.empty();
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let hasVisibleEvents = false;

                monthlyEventsData.forEach(item => {
                    const itemDate = new Date(item.date + 'T00:00:00');
                    if (itemDate < today) {
                        return; // Skip past dates
                    }

                    const dayOfWeek = itemDate.getDay(); // 0 = Sunday, 6 = Saturday
                    if (dayFilter === 'weekend' && dayOfWeek !== 0 && dayOfWeek !== 6) {
                        return; // Skip non-weekend days if filter is active
                    }

                    hasVisibleEvents = true;
                    const detailsContent = isUserView 
                        ? (item.details || '-')
                        : `<input type="text" class="form-control event-details" value="${item.details || ''}">`;

                    const row = `
                        <tr data-date="${item.date}">
                            <td>${formatShortDate(item.date)}</td>
                            <td>${getDayName(item.date)}</td>
                            <td>${detailsContent}</td>
                        </tr>
                    `;
                    $tbody.append(row);
                });

                if (!hasVisibleEvents) {
                    $tbody.html('<tr><td colspan="3" class="text-center py-4">ไม่พบข้อมูลสำหรับช่วงเวลาที่เลือก</td></tr>');
                }
            }
            
            // --- DATA FUNCTIONS ---
            function fetchEvents() {
                const isUserView = currentView === 'user';
                const year = $(isUserView ? '#year-select-user' : '#year-select-admin').val();
                const month = $(isUserView ? '#month-select-user' : '#month-select-admin').val();

                if (!year || !month) {
                    monthlyEventsData = [];
                    renderCurrentTable();
                    return;
                }

                showLoader('กำลังโหลดข้อมูล');

                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: { action: 'getEvents', year: year, month: month }
                }).done(function(response) {
                    Swal.close();
                    if (response.success) {
                        monthlyEventsData = response.data;
                        renderCurrentTable();
                    } else {
                        Swal.fire('เกิดข้อผิดพลาด!', response.message || 'ไม่สามารถโหลดข้อมูลได้', 'error');
                    }
                }).fail(function() {
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว', 'error');
                });
            }

            // --- EVENT HANDLERS ---
            $('#login-form').on('submit', function(e) {
                e.preventDefault();
                const username = $('#username').val();
                const password = $('#password').val();
                
                showLoader('กำลังเข้าสู่ระบบ');
                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: { action: 'login', username: username, password: password }
                }).done(function(response) {
                    if (response.success) {
                        Swal.fire('สำเร็จ!', 'เข้าสู่ระบบเรียบร้อย', 'success');
                        $('#loginModal').modal('hide');
                        $('#login-btn').hide();
                        $('#logout-btn').show();
                        $('#user-view').hide();
                        $('#admin-view').show();
                        currentView = 'admin';
                        fetchEvents();
                    } else {
                        Swal.fire('ผิดพลาด!', 'Username หรือ Password ไม่ถูกต้อง', 'error');
                    }
                }).fail(function() {
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อล้มเหลว', 'error');
                });
            });

            $('#logout-btn').on('click', function() {
                $('#login-btn').show();
                $('#logout-btn').hide();
                $('#admin-view').hide();
                $('#user-view').show();
                currentView = 'user';
                fetchEvents();
            });

            $('#save-btn').on('click', function() {
                const dataToSave = [];
                $('#events-table-body-admin tr').each(function() {
                    const date = $(this).data('date');
                    if(date){ // Ensure it's a data row
                        const details = $(this).find('.event-details').val();
                        dataToSave.push({ date: date, details: details });
                    }
                });

                showLoader('กำลังบันทึกข้อมูล');
                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: { action: 'saveEvents', data: JSON.stringify(dataToSave) }
                }).done(function(response) {
                     if (response.success) {
                        Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อย', 'success');
                    } else {
                        Swal.fire('ผิดพลาด!', response.message || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                    }
                }).fail(function() {
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อล้มเหลว', 'error');
                });
            });

            $('#year-select-user, #year-select-admin').on('change', function() {
                updateMonthDropdowns();
                fetchEvents();
            });

            $('#month-select-user, #month-select-admin').on('change', fetchEvents);

            $('.day-filter').on('change', function() {
                dayFilter = $(this).val();
                renderCurrentTable();
            });

            // --- INITIALIZATION ---
            initializeDropdowns();
            fetchEvents();
        });
    </script>

</body>
</html>
