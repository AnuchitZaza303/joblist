<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแจ้งงาน - ป.บันเทิงศิลป์</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        :root {
            --bg-color: #F9FAFB; /* Soft Gray Background */
            --primary-color: #3B82F6; /* Professional Blue */
            --primary-light: #DBEAFE; /* Lighter Blue for highlights */
            --text-color: #1F2937; /* Dark Charcoal for text */
            --border-color: #E5E7EB; /* Subtle borders */
            --white-color: #FFFFFF;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .navbar {
            background-color: var(--white-color);
            border-bottom: 1px solid var(--border-color);
        }
        
        .navbar-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }

        .navbar-brand p {
            font-size: 0.9rem;
            margin: 0;
            color: #6B7280; /* Medium Gray */
        }

        .card {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* More rounded corners */
            box-shadow: 0 4px 12px rgba(0,0,0,.05);
            background-color: var(--white-color);
        }

        .table thead {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .table th, .table td {
            vertical-align: middle;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
        }

        .btn {
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 500;
        }

        .btn-primary:hover {
            background-color: #2563EB; /* Darker blue on hover */
            border-color: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 500;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        #admin-view {
            display: none;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
        }

        .progress-bar-custom {
            width: 0%;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <h1>ระบบแจ้งงาน</h1>
                <p>วงดนตรีอยุธยา ป.บันเทิงศิลป์</p>
            </a>
            <div class="d-flex">
                <button id="login-btn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Admin Login</button>
                <button id="logout-btn" class="btn btn-danger" style="display:none;">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4 mb-4">
        <!-- User View -->
        <div id="user-view">
            <div class="card">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">ตารางงาน</h5>
                    <div class="row g-3 align-items-center mb-3">
                        <div class="col-auto">
                            <label for="month-select-user" class="col-form-label">เลือกเดือน:</label>
                        </div>
                        <div class="col-md-4">
                            <select id="month-select-user" class="form-select"></select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 20%;">วันที่</th>
                                    <th scope="col" style="width: 20%;">วัน</th>
                                    <th scope="col">รายละเอียดงาน</th>
                                </tr>
                            </thead>
                            <tbody id="events-table-body-user">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view">
            <div class="card">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">จัดการข้อมูลงาน (Admin)</h5>
                     <div class="row g-3 align-items-center mb-3">
                        <div class="col-auto">
                            <label for="month-select-admin" class="col-form-label">เลือกเดือน:</label>
                        </div>
                        <div class="col-md-4">
                            <select id="month-select-admin" class="form-select"></select>
                        </div>
                    </div>
                    <div class="table-responsive">
                         <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 20%;">วันที่</th>
                                    <th scope="col" style="width: 20%;">วัน</th>
                                    <th scope="col">รายละเอียดงาน</th>
                                </tr>
                            </thead>
                            <tbody id="events-table-body-admin">
                                <!-- Admin data form will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <button id="save-btn" class="btn btn-primary w-100 mt-3 py-2">บันทึกข้อมูล</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Admin Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function() {
            // --- CONFIGURATION ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMaQEh2viEg7ufz8gQfsEoovDz0cW9FhC64x_awDHcyAKNzXx0g6hCDtz2FfEF9J1L2Q/exec";

            // --- STATE ---
            let currentView = 'user';

            // --- HELPER FUNCTIONS ---
            function getDayName(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('th-TH', { weekday: 'long' });
            }

            // --- UI FUNCTIONS ---
            function populateDateDropdowns() {
                const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                const startYear = 2025; // 2568
                const endYear = 2026;   // 2569
                const startMonth = 7; // สิงหาคม (0-indexed)

                const $selectUser = $('#month-select-user');
                const $selectAdmin = $('#month-select-admin');
                
                $selectUser.empty();
                $selectAdmin.empty();

                for (let year = startYear; year <= endYear; year++) {
                    const monthStart = (year === startYear) ? startMonth : 0;
                    const monthEnd = (year === endYear) ? 11 : 11;
                    for (let month = monthStart; month <= monthEnd; month++) {
                        const monthName = months[month];
                        const beYear = year + 543;
                        const value = `${year}-${String(month + 1).padStart(2, '0')}`;
                        const optionText = `${monthName} ${beYear}`;
                        $selectUser.append(`<option value="${value}">${optionText}</option>`);
                        $selectAdmin.append(`<option value="${value}">${optionText}</option>`);
                    }
                }
            }

            function showLoader(title) {
                Swal.fire({
                    title: title,
                    html: `
                        <p>กำลังดำเนินการ...</p>
                        <div class="progress-container">
                            <div id="swal-progress-bar" class="progress-bar-custom"></div>
                        </div>
                    `,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                        let progress = 0;
                        const interval = setInterval(() => {
                            progress += 5;
                            $('#swal-progress-bar').css('width', progress + '%');
                            if (progress >= 100) {
                                clearInterval(interval);
                            }
                        }, 50);
                    }
                });
            }

            function renderUserTable(data) {
                const $tbody = $('#events-table-body-user');
                $tbody.empty();
                if (data.length === 0) {
                    $tbody.html('<tr><td colspan="3" class="text-center py-4">ไม่พบข้อมูลสำหรับเดือนนี้</td></tr>');
                    return;
                }
                data.forEach(item => {
                    const row = `
                        <tr>
                            <td>${new Date(item.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' })}</td>
                            <td>${getDayName(item.date)}</td>
                            <td>${item.details || '-'}</td>
                        </tr>
                    `;
                    $tbody.append(row);
                });
            }

            function renderAdminTable(data) {
                const $tbody = $('#events-table-body-admin');
                $tbody.empty();
                 if (data.length === 0) {
                    $tbody.html('<tr><td colspan="3" class="text-center py-4">ไม่สามารถโหลดข้อมูลได้ กรุณาลองอีกครั้ง</td></tr>');
                    return;
                }
                data.forEach(item => {
                    const row = `
                        <tr data-date="${item.date}">
                            <td>${new Date(item.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' })}</td>
                            <td>${getDayName(item.date)}</td>
                            <td>
                                <input type="text" class="form-control event-details" value="${item.details || ''}">
                            </td>
                        </tr>
                    `;
                    $tbody.append(row);
                });
            }
            
            // --- DATA FUNCTIONS ---
            function fetchEvents() {
                const selectedMonth = (currentView === 'user') ? $('#month-select-user').val() : $('#month-select-admin').val();
                if (!selectedMonth) return;

                const [year, month] = selectedMonth.split('-');
                showLoader('กำลังโหลดข้อมูล');

                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: {
                        action: 'getEvents',
                        year: year,
                        month: month
                    }
                }).done(function(response) {
                    Swal.close();
                    if (response.success) {
                        if (currentView === 'user') {
                            renderUserTable(response.data);
                        } else {
                            renderAdminTable(response.data);
                        }
                    } else {
                        Swal.fire('เกิดข้อผิดพลาด!', response.message || 'ไม่สามารถโหลดข้อมูลได้', 'error');
                    }
                }).fail(function() {
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อกับเซิร์ฟเวอร์ล้มเหลว', 'error');
                });
            }

            // --- EVENT HANDLERS ---
            $('#login-form').on('submit', function(e) {
                e.preventDefault();
                const username = $('#username').val();
                const password = $('#password').val();
                
                showLoader('กำลังเข้าสู่ระบบ');

                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: {
                        action: 'login',
                        username: username,
                        password: password
                    }
                }).done(function(response) {
                    if (response.success) {
                        Swal.fire('สำเร็จ!', 'เข้าสู่ระบบเรียบร้อย', 'success');
                        $('#loginModal').modal('hide');
                        $('#login-btn').hide();
                        $('#logout-btn').show();
                        $('#user-view').hide();
                        $('#admin-view').show();
                        currentView = 'admin';
                        fetchEvents();
                    } else {
                        Swal.fire('ผิดพลาด!', 'Username หรือ Password ไม่ถูกต้อง', 'error');
                    }
                }).fail(function() {
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อล้มเหลว', 'error');
                });
            });

            $('#logout-btn').on('click', function() {
                $('#login-btn').show();
                $('#logout-btn').hide();
                $('#admin-view').hide();
                $('#user-view').show();
                currentView = 'user';
                fetchEvents();
            });

            $('#save-btn').on('click', function() {
                const dataToSave = [];
                const selectedMonth = $('#month-select-admin').val();

                $('#events-table-body-admin tr').each(function() {
                    const date = $(this).data('date');
                    const details = $(this).find('.event-details').val();
                    dataToSave.push({ date: date, details: details });
                });

                showLoader('กำลังบันทึกข้อมูล');

                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET', // JSONP uses GET
                    dataType: 'jsonp',
                    data: {
                        action: 'saveEvents',
                        data: JSON.stringify(dataToSave)
                    }
                }).done(function(response) {
                    if (response.success) {
                        Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อย', 'success');
                    } else {
                        Swal.fire('ผิดพลาด!', response.message || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                    }
                }).fail(function() {
                    Swal.fire('เกิดข้อผิดพลาด!', 'การเชื่อมต่อล้มเหลว', 'error');
                });
            });

            $('#month-select-user, #month-select-admin').on('change', fetchEvents);

            // --- INITIALIZATION ---
            populateDateDropdowns();
            fetchEvents();
        });
    </script>

</body>
</html>
