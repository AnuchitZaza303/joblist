<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแจ้งงาน - ป.บันเทิงศิลป์</title>
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        :root {
            --bg-color: #F9FAFB; --primary-color: #3B82F6; --primary-light: #DBEAFE;
            --text-color: #1F2937; --border-color: #E5E7EB; --white-color: #FFFFFF;
            --danger-color: #EF4444; --danger-light: #FEE2E2;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); color: var(--text-color); -webkit-text-size-adjust: 100%; }
        .navbar { background-color: var(--white-color); border-bottom: 1px solid var(--border-color); }
        .navbar-brand { display: flex; align-items: center; }
        .navbar-brand img { max-height: 40px; margin-right: 10px; }
        .navbar-brand h1 { font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--primary-color); }
        .navbar-brand p { font-size: 0.9rem; margin: 0; color: #6B7280; }
        .card { border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,.05); background-color: var(--white-color); }
        .card-title i { margin-right: 0.5rem; color: var(--primary-color); }
        .table { word-wrap: break-word; }
        .table thead { background-color: var(--primary-light); color: var(--primary-color); font-weight: 600; }
        .table th, .table td { vertical-align: middle; }
        .table .date-col { width: 30%; }
        .table .day-col { width: 25%; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); }
        .btn { border-radius: 0.5rem; transition: all 0.2s ease-in-out; }
        .btn i { margin-right: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); font-weight: 500; }
        .btn-primary:hover { background-color: #2563EB; border-color: #2563EB; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2); }
        .btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); font-weight: 500; }
        .btn-outline-primary:hover, .btn-check:checked+.btn-outline-primary { background-color: var(--primary-color); color: var(--white-color); }
        .admin-nav .nav-link { color: #6B7280; }
        .admin-nav .nav-link.active { color: var(--primary-color); font-weight: 600; border-bottom: 2px solid var(--primary-color); }
        #admin-section, #settings-view { display: none; }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-top: 10px; }
        .progress-bar-custom { width: 0%; height: 10px; background-color: var(--primary-color); border-radius: 5px; transition: width 0.2s ease-in-out; }
        .reset-zone { border: 1px solid var(--danger-light); background-color: var(--danger-light); border-radius: 0.5rem; padding: 1rem; }
        .reset-zone h6 { color: var(--danger-color); }
        @media (max-width: 576px) {
            .navbar-brand h1 { font-size: 1.25rem; }
            .navbar-brand p { font-size: 0.8rem; }
            .card-body { padding: 1rem; }
            .table { font-size: 0.9rem; }
            .table th, .table td { padding: 0.75rem 0.5rem; }
            .table .date-col, .table .day-col { width: auto; min-width: 110px; }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a id="main-navbar-brand" class="navbar-brand" href="#">
                <img id="brand-logo" src="" alt="Logo" style="display: none;">
                <div>
                    <h1 id="brand-title">ระบบแจ้งงาน</h1>
                    <p id="brand-subtitle">วงดนตรีอยุธยา ป.บันเทิงศิลป์</p>
                </div>
            </a>
            <div class="d-flex">
                <button id="login-btn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
                    <i class="fa-solid fa-right-to-bracket"></i><span class="d-none d-sm-inline ms-1">Admin Login</span>
                </button>
                <button id="logout-btn" class="btn btn-danger" style="display:none;">
                    <i class="fa-solid fa-right-from-bracket"></i><span class="d-none d-sm-inline ms-1">Logout</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4 mb-4">
        <!-- User View -->
        <div id="user-view">
             <div class="card">
                <div class="card-body p-md-4">
                    <h5 class="card-title mb-3"><i class="fa-solid fa-calendar-days"></i>ตารางงาน</h5>
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-6 col-sm-4 col-md-3">
                             <label for="year-select-user" class="form-label visually-hidden">ปี</label>
                             <select id="year-select-user" class="form-select"></select>
                        </div>
                        <div class="col-6 col-sm-5 col-md-4">
                             <label for="month-select-user" class="form-label visually-hidden">เดือน</label>
                             <select id="month-select-user" class="form-select"></select>
                        </div>
                        <div class="col-12 col-sm-auto ms-sm-auto mt-2 mt-sm-0">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check day-filter" name="dayFilterUser" id="allDaysUser" value="all" checked>
                                <label class="btn btn-outline-primary btn-sm" for="allDaysUser">ทุกวัน</label>
                                <input type="radio" class="btn-check day-filter" name="dayFilterUser" id="weekendUser" value="weekend">
                                <label class="btn btn-outline-primary btn-sm" for="weekendUser">ส./อา.</label>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col" class="date-col">วันที่</th>
                                    <th scope="col" class="day-col">วัน</th>
                                    <th scope="col">รายละเอียดงาน</th>
                                </tr>
                            </thead>
                            <tbody id="events-table-body-user"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section">
            <ul class="nav nav-tabs mb-3 admin-nav">
                <li class="nav-item"><a class="nav-link active" href="#" id="admin-data-tab"><i class="fa-solid fa-calendar-days"></i> จัดการข้อมูล</a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="admin-settings-tab"><i class="fa-solid fa-gear"></i> ตั้งค่าระบบ</a></li>
            </ul>
            <div id="admin-data-view">
                 <div class="card">
                    <div class="card-body p-md-4">
                        <div class="row g-2 align-items-center mb-3">
                            <div class="col-6 col-sm-4 col-md-3">
                                 <label for="year-select-admin" class="form-label visually-hidden">ปี</label>
                                 <select id="year-select-admin" class="form-select"></select>
                            </div>
                            <div class="col-6 col-sm-5 col-md-4">
                                 <label for="month-select-admin" class="form-label visually-hidden">เดือน</label>
                                 <select id="month-select-admin" class="form-select"></select>
                            </div>
                            <div class="col-12 col-sm-auto ms-sm-auto mt-2 mt-sm-0">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check day-filter" name="dayFilterAdmin" id="allDaysAdmin" value="all" checked>
                                    <label class="btn btn-outline-primary btn-sm" for="allDaysAdmin">ทุกวัน</label>
                                    <input type="radio" class="btn-check day-filter" name="dayFilterAdmin" id="weekendAdmin" value="weekend">
                                    <label class="btn btn-outline-primary btn-sm" for="weekendAdmin">ส./อา.</label>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                             <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col" class="date-col">วันที่</th>
                                        <th scope="col" class="day-col">วัน</th>
                                        <th scope="col">รายละเอียดงาน</th>
                                    </tr>
                                </thead>
                                <tbody id="events-table-body-admin"></tbody>
                            </table>
                        </div>
                        <button id="save-btn" class="btn btn-primary w-100 mt-3 py-2"><i class="fa-solid fa-floppy-disk"></i>บันทึกข้อมูล</button>
                    </div>
                </div>
            </div>
            <div id="settings-view">
                <div class="card">
                    <div class="card-body p-md-4">
                        <h5 class="card-title mb-4"><i class="fa-solid fa-sliders"></i>ตั้งค่าระบบทั่วไป</h5>
                        <div class="mb-3">
                            <label for="siteNameInput" class="form-label">ชื่อเว็บ</label>
                            <input type="text" class="form-control" id="siteNameInput">
                        </div>
                        <div class="mb-3">
                            <label for="siteSubtitleInput" class="form-label">คำอธิบายใต้ชื่อเว็บ</label>
                            <input type="text" class="form-control" id="siteSubtitleInput">
                        </div>
                        <div class="mb-3">
                            <label for="logoUrlInput" class="form-label">URL โลโก้ (ถ้ามี)</label>
                            <input type="text" class="form-control" id="logoUrlInput">
                        </div>
                        <button id="save-settings-btn" class="btn btn-primary w-100 mt-3 py-2"><i class="fa-solid fa-floppy-disk"></i>บันทึกการตั้งค่า</button>
                    </div>
                </div>
                <div class="card mt-4">
                    <div class="card-body p-md-4">
                         <div class="reset-zone">
                             <h6 class="fw-bold"><i class="fa-solid fa-triangle-exclamation"></i> พื้นที่อันตราย</h6>
                             <p class="small text-muted">การรีเซ็ตระบบจะลบข้อมูลทั้งหมดและคืนค่าเริ่มต้นจากโรงงาน ไม่สามารถกู้คืนได้</p>
                             <button id="reset-system-btn" class="btn btn-danger w-100"><i class="fa-solid fa-arrows-rotate"></i>รีเซ็ตระบบทั้งหมด</button>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Admin Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"><i class="fa-solid fa-right-to-bracket"></i>Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function() {
            // --- CONFIGURATION ---
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNi3WtaeECmpk5G9jdunyg2prrdIqBw4_4Bi1kFpso9KXRBSLyIjFqMSlX5vlmfsyPrw/exec";
            const START_YEAR = 2025;
            const END_YEAR = 2026;
            const APP_START_MONTH = 7; 

            // --- STATE ---
            let currentView = 'user';
            let siteSettings = {};
            let allEventsData = []; 
            let dayFilter = 'all';
            let loaderInterval = null;

            // --- HELPER FUNCTIONS ---
            function getDayName(dateString) {
                const date = new Date(dateString + "T00:00:00");
                return date.toLocaleDateString('th-TH', { weekday: 'long' });
            }

            function toYYYYMMDD(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatShortDate(dateString) {
                const date = new Date(dateString + "T00:00:00");
                const shortMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
                const day = date.getDate();
                const monthIndex = date.getMonth();
                const month = shortMonths[monthIndex];
                const year = (date.getFullYear() + 543).toString().slice(-2);
                return `${day} ${month} ${year}`;
            }

            // --- UI FUNCTIONS ---
            function updateBrandUI() {
                $('#brand-title').text(siteSettings.siteName || 'ระบบแจ้งงาน');
                $('#brand-subtitle').text(siteSettings.siteSubtitle || 'ป.บันเทิงศิลป์');
                if (siteSettings.logoUrl && siteSettings.logoUrl.trim() !== '') {
                    $('#brand-logo').attr('src', siteSettings.logoUrl).show();
                } else {
                    $('#brand-logo').hide();
                }
            }
            
            function populateSettingsForm() {
                $('#siteNameInput').val(siteSettings.siteName || '');
                $('#siteSubtitleInput').val(siteSettings.siteSubtitle || '');
                $('#logoUrlInput').val(siteSettings.logoUrl || '');
            }

            function initializeDropdowns() {
                const $yearSelectUser = $('#year-select-user');
                const $yearSelectAdmin = $('#year-select-admin');
                $yearSelectUser.empty();
                $yearSelectAdmin.empty();

                for (let year = START_YEAR; year <= END_YEAR; year++) {
                    const beYear = year + 543;
                    $yearSelectUser.append(`<option value="${year}">พ.ศ. ${beYear}</option>`);
                    $yearSelectAdmin.append(`<option value="${year}">พ.ศ. ${beYear}</option>`);
                }

                updateMonthDropdowns();
            }

            function updateMonthDropdowns() {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();

                const selectedYearUser = parseInt($('#year-select-user').val());
                const selectedYearAdmin = parseInt($('#year-select-admin').val());

                populateMonthsForYear('#month-select-user', selectedYearUser, currentYear, currentMonth);
                populateMonthsForYear('#month-select-admin', selectedYearAdmin, currentYear, currentMonth);
            }

            function populateMonthsForYear(selector, selectedYear, currentYear, currentMonth) {
                const $monthSelect = $(selector);
                const currentVal = $monthSelect.val();
                $monthSelect.empty();
                const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
                
                let startMonth = 0;
                if (selectedYear === START_YEAR) {
                    startMonth = APP_START_MONTH;
                }
                if (selectedYear === currentYear) {
                    startMonth = Math.max(startMonth, currentMonth);
                }

                for (let i = startMonth; i < 12; i++) {
                    const monthValue = String(i + 1).padStart(2, '0');
                    $monthSelect.append(`<option value="${monthValue}">${months[i]}</option>`);
                }
                if(currentVal) $monthSelect.val(currentVal);
            }

            function showLoader(title) {
                Swal.fire({
                    title: title,
                    html: `
                        <p>กำลังดำเนินการ...</p>
                        <div class="progress-container">
                            <div id="swal-progress-bar" class="progress-bar-custom" style="width: 10%"></div>
                        </div>
                    `,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                        let progress = 10;
                        if(loaderInterval) clearInterval(loaderInterval);
                        loaderInterval = setInterval(() => {
                            progress = Math.min(progress + Math.floor(Math.random() * 5) + 2, 95);
                            const progressBar = Swal.getHtmlContainer()?.querySelector('#swal-progress-bar');
                            if (progressBar) {
                                progressBar.style.width = progress + '%';
                            }
                        }, 200);
                    }
                });
            }

            function completeLoader(callback) {
                if (loaderInterval) clearInterval(loaderInterval);
                const progressBar = Swal.getHtmlContainer()?.querySelector('#swal-progress-bar');
                if (progressBar) {
                    progressBar.style.width = '100%';
                }
                setTimeout(() => {
                    Swal.close();
                    if (callback) callback();
                }, 400);
            }
            
            function renderFilteredTable() {
                const isUserView = currentView === 'user';
                const year = parseInt($(isUserView ? '#year-select-user' : '#year-select-admin').val());
                const month = parseInt($(isUserView ? '#month-select-user' : '#month-select-admin').val());
                const tbodySelector = isUserView ? '#events-table-body-user' : '#events-table-body-admin';
                const $tbody = $(tbodySelector);
                $tbody.empty();

                if (!year || !month) {
                    $tbody.html('<tr><td colspan="3" class="text-center py-4">ไม่พบข้อมูลสำหรับเดือนปัจจุบัน</td></tr>');
                    return;
                }
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let hasVisibleEvents = false;
                const yearMonthPrefix = `${year}-${String(month).padStart(2, '0')}`;

                const filteredEvents = allEventsData.filter(item => item.date.startsWith(yearMonthPrefix));

                const allDaysInMonth = [];
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0);
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    allDaysInMonth.push(toYYYYMMDD(new Date(d)));
                }

                allDaysInMonth.forEach(dateString => {
                    const itemDate = new Date(dateString + 'T00:00:00');
                    if (itemDate < today) return;

                    const dayOfWeek = itemDate.getDay();
                    if (dayFilter === 'weekend' && dayOfWeek !== 0 && dayOfWeek !== 6) return;

                    const eventDetails = filteredEvents.find(e => e.date === dateString)?.details || '';
                    
                    if (isUserView && !eventDetails) return;

                    hasVisibleEvents = true;
                    const detailsContent = isUserView 
                        ? (eventDetails || '-')
                        : `<input type="text" class="form-control event-details" value="${eventDetails || ''}">`;

                    const row = `<tr data-date="${dateString}"><td>${formatShortDate(dateString)}</td><td>${getDayName(dateString)}</td><td>${detailsContent}</td></tr>`;
                    $tbody.append(row);
                });


                if (!hasVisibleEvents) {
                    $tbody.html('<tr><td colspan="3" class="text-center py-4">ไม่พบข้อมูลสำหรับช่วงเวลาที่เลือก</td></tr>');
                }
            }
            
            // --- DATA FUNCTIONS ---
            function handleAjaxError(textStatus) {
                if(loaderInterval) clearInterval(loaderInterval);
                let errorMsg = 'การเชื่อมต่อล้มเหลว';
                if (textStatus === 'timeout') {
                    errorMsg = 'เซิร์ฟเวอร์ใช้เวลาตอบกลับนานเกินไป';
                } else if (textStatus === 'parsererror') {
                    errorMsg = 'การประมวลผลข้อมูลจากเซิร์ฟเวอร์ผิดพลาด';
                }
                Swal.fire('เกิดข้อผิดพลาด!', errorMsg + ' กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองใหม่อีกครั้ง', 'error');
            }

            function handleInvalidResponse() {
                if(loaderInterval) clearInterval(loaderInterval);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาดในการสื่อสาร',
                    html: 'ได้รับข้อมูลจากเซิร์ฟเวอร์ในรูปแบบที่ไม่ถูกต้อง<br><br><b>สาเหตุที่เป็นไปได้:</b><br>1. Deploy ใน Google Apps Script ไม่ถูกต้อง (ต้องตั้งค่า "Who has access" เป็น "Anyone")<br>2. URL ของ Script ไม่ถูกต้อง',
                });
            }

            function loadInitialData() {
                showLoader('กำลังโหลดข้อมูลระบบ...');
                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: { action: 'getCache' },
                    timeout: 20000
                }).done(function(response) {
                    if (!response || typeof response.success === 'undefined') {
                        handleInvalidResponse();
                        return;
                    }
                    completeLoader(() => {
                        if (response.success) {
                            siteSettings = response.settings;
                            allEventsData = response.events;
                            updateBrandUI();
                            populateSettingsForm();
                            initializeDropdowns();
                            renderFilteredTable();
                        } else {
                             Swal.fire('เกิดข้อผิดพลาด!', response.message || 'ไม่สามารถโหลดข้อมูลเริ่มต้นได้', 'error');
                        }
                    });
                }).fail(function(jqXHR, textStatus) {
                    handleAjaxError(textStatus);
                });
            }

            // --- EVENT HANDLERS ---
            $('#login-form').on('submit', function(e) {
                e.preventDefault();
                const username = $('#username').val();
                const password = $('#password').val();
                
                showLoader('กำลังเข้าสู่ระบบ');
                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: { action: 'login', username: username, password: password },
                    timeout: 15000
                }).done(function(response) {
                    if (!response || typeof response.success === 'undefined') {
                        handleInvalidResponse();
                        return;
                    }
                    completeLoader(() => {
                        if (response.success) {
                            Swal.fire('สำเร็จ!', 'เข้าสู่ระบบเรียบร้อย', 'success');
                            $('#loginModal').modal('hide');
                            $('#login-btn').hide();
                            $('#logout-btn').show();
                            $('#user-view').hide();
                            $('#admin-section').show();
                            $('#admin-data-view').show();
                            $('#settings-view').hide();
                            $('#admin-data-tab').addClass('active');
                            $('#admin-settings-tab').removeClass('active');
                            currentView = 'admin';
                            renderFilteredTable();
                        } else {
                            Swal.fire('ผิดพลาด!', 'Username หรือ Password ไม่ถูกต้อง', 'error');
                        }
                    });
                }).fail(function(jqXHR, textStatus) {
                    handleAjaxError(textStatus);
                });
            });

            $('#logout-btn').on('click', function() {
                $('#login-btn').show();
                $('#logout-btn').hide();
                $('#admin-section').hide();
                $('#user-view').show();
                currentView = 'user';
                renderFilteredTable();
            });

            $('#admin-data-tab').on('click', function(e) {
                e.preventDefault();
                $('#settings-view').hide();
                $('#admin-data-view').show();
                $(this).addClass('active');
                $('#admin-settings-tab').removeClass('active');
            });

            $('#admin-settings-tab').on('click', function(e) {
                e.preventDefault();
                $('#admin-data-view').hide();
                $('#settings-view').show();
                $(this).addClass('active');
                $('#admin-data-tab').removeClass('active');
            });

            $('#save-settings-btn').on('click', function() {
                const newSettings = {
                    siteName: $('#siteNameInput').val(),
                    siteSubtitle: $('#siteSubtitleInput').val(),
                    logoUrl: $('#logoUrlInput').val()
                };
                showLoader('กำลังบันทึกการตั้งค่า');
                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: { action: 'saveSettings', data: JSON.stringify(newSettings) },
                    timeout: 15000
                }).done(function(response) {
                    if (!response || typeof response.success === 'undefined') {
                        handleInvalidResponse();
                        return;
                    }
                    completeLoader(() => {
                        if (response.success) {
                            Swal.fire('สำเร็จ!', 'บันทึกการตั้งค่าเรียบร้อย', 'success');
                            siteSettings = newSettings;
                            updateBrandUI();
                        } else {
                            Swal.fire('ผิดพลาด!', response.message || 'ไม่สามารถบันทึกได้', 'error');
                        }
                    });
                }).fail(function(jqXHR, textStatus) {
                    handleAjaxError(textStatus);
                });
            });

            $('#save-btn').on('click', function() {
                const eventsForMonth = [];
                const year = $('#year-select-admin').val();
                const month = $('#month-select-admin').val();
                const yearMonth = `${year}-${month}`;

                $('#events-table-body-admin tr').each(function() {
                    const date = $(this).data('date');
                    if (date) {
                        const details = $(this).find('.event-details').val();
                        if (details && details.trim() !== '') {
                            eventsForMonth.push({ date: date, details: details });
                        }
                    }
                });
                
                const payload = {
                    yearMonth: yearMonth,
                    events: eventsForMonth
                };

                showLoader('กำลังบันทึกข้อมูล');
                $.ajax({
                    url: SCRIPT_URL,
                    method: 'GET',
                    dataType: 'jsonp',
                    data: { action: 'saveEvents', data: JSON.stringify(payload) },
                    timeout: 20000
                }).done(function(response) {
                     if (!response || typeof response.success === 'undefined') {
                        handleInvalidResponse();
                        return;
                    }
                     completeLoader(() => {
                         if (response.success) {
                            Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อย', 'success').then(() => location.reload());
                        } else {
                            Swal.fire('ผิดพลาด!', response.message || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                        }
                     });
                }).fail(function(jqXHR, textStatus) {
                    handleAjaxError(textStatus);
                });
            });

            $('#year-select-user, #year-select-admin').on('change', function() {
                updateMonthDropdowns();
                renderFilteredTable();
            });
            $('#month-select-user, #month-select-admin').on('change', renderFilteredTable);
            $('.day-filter').on('change', function() {
                const name = $(this).attr('name');
                dayFilter = $(`input[name="${name}"]:checked`).val();
                renderFilteredTable();
            });
            
            $('#reset-system-btn').on('click', function() {
                Swal.fire({
                    title: 'คุณแน่ใจหรือไม่?',
                    text: "การดำเนินการนี้จะลบข้อมูลทั้งหมดและไม่สามารถกู้คืนได้!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ใช่, รีเซ็ตเลย!',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        executeSystemReset();
                    }
                })
            });

            function executeSystemReset() {
                Swal.fire({
                    title: 'กำลังรีเซ็ตระบบ...',
                    html: 'กรุณารอสักครู่',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
                setTimeout(() => {
                    Swal.update({ html: 'ขั้นตอนที่ 1/3: กำลังลบข้อมูลเก่า...' });
                    setTimeout(() => {
                        Swal.update({ html: 'ขั้นตอนที่ 2/3: กำลังสร้างชีตและข้อมูลเริ่มต้น...' });
                        $.ajax({
                            url: SCRIPT_URL,
                            method: 'GET',
                            dataType: 'jsonp',
                            data: { action: 'resetSystem' },
                            timeout: 30000
                        }).done(function(response) {
                            if (!response || typeof response.success === 'undefined') {
                                handleInvalidResponse();
                                return;
                            }
                            Swal.update({ html: 'ขั้นตอนที่ 3/3: กำลังรีเฟรชหน้าเว็บ...' });
                            if (response.success) {
                                Swal.fire({
                                    title: 'รีเซ็ตสำเร็จ!',
                                    text: 'ระบบได้กลับสู่ค่าเริ่มต้นแล้ว',
                                    icon: 'success'
                                }).then(() => { location.reload(); });
                            } else {
                                Swal.fire('ผิดพลาด!', response.message || 'ไม่สามารถรีเซ็ตระบบได้', 'error');
                            }
                        }).fail(function(jqXHR, textStatus) {
                            handleAjaxError(textStatus);
                        });
                    }, 1500);
                }, 1000);
            }

            // --- INITIALIZATION ---
            loadInitialData();
        });
    </script>
</body>
</html>
